<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Structure Enrichie - Fractions</title>
    <link rel="stylesheet" href="src/styles/index.css">
</head>
<body>
    
    <div class="main-container">
        <h1>📚 Comprendre les fractions</h1>
        
        <!-- Section d'informations générales -->
        <div class="info-section">
            <div class="section">
                <h3>🎯 Objectif</h3>
                <p>Savoir lire, écrire et représenter une fraction.</p>
            </div>
            
            <div class="info-grid">
                <div class="info-card utilite-card">
                    <h4>🌍 Pourquoi c'est important ?</h4>
                    <p>Les fractions sont essentielles pour cuisiner, partager des objets, calculer des remises, comprendre les pourcentages et gérer son budget.</p>
                </div>
                
                <div class="info-card funfact-card">
                    <h4>🤯 Fun Fact</h4>
                    <p>Dans une étude américaine, 3 adultes sur 5 ont avoué qu'ils préféraient partager une pizza plutôt que des bonbons… mais 2 sur 5 ne savaient pas calculer 3/8 d'une pizza ! 🍕😂</p>
                </div>
            </div>
        </div>

        <!-- Phase 1: Test de Pré-évaluation -->
        <div class="collapsible-section">
            <div class="collapsible-header" id="preEvalHeader" onclick="toggleSection('preEval')">
                <span>🔍 Phase 1: Test de Pré-évaluation</span>
                <span class="collapsible-icon">🔽</span>
            </div>
            <div class="collapsible-content expanded" id="preEvalContent">
                <div class="collapsible-inner">
                    <div class="section pre-evaluation" id="preEvaluation">
                        <p>Ce test permet de voir si tu es déjà à l'aise avec ce sujet.</p>
                        
                        <div class="mini-test">
                            <h4>📋 Mini-test rapide</h4>
                            
                            <!-- Question 1 -->
                            <div class="test-question">
                                <p><strong>1.</strong> Dans la fraction 7/9, quel est le dénominateur ?</p>
                                <div class="test-options">
                                    <button class="test-option" onclick="answerPreTest(1, 'wrong', this)">7</button>
                                    <button class="test-option" onclick="answerPreTest(1, 'correct', this)">9</button>
                                    <button class="test-option" onclick="answerPreTest(1, 'wrong', this)">16</button>
                                    <button class="test-option" onclick="answerPreTest(1, 'wrong', this)">2</button>
                                </div>
                            </div>
                            
                            <!-- Question 2 -->
                            <div class="test-question">
                                <p><strong>2.</strong> Que représente la fraction 3/4 ?</p>
                                <div class="test-options">
                                    <button class="test-option" onclick="answerPreTest(2, 'wrong', this)">3 + 4</button>
                                    <button class="test-option" onclick="answerPreTest(2, 'correct', this)">3 parts sur 4</button>
                                    <button class="test-option" onclick="answerPreTest(2, 'wrong', this)">4 parts sur 3</button>
                                    <button class="test-option" onclick="answerPreTest(2, 'wrong', this)">3 × 4</button>
                                </div>
                            </div>
                            
                            <!-- Question 3 -->
                            <div class="test-question">
                                <p><strong>3.</strong> Si je colorie 2 carrés sur 5, quelle fraction cela représente-t-il ?</p>
                                <div class="test-options">
                                    <button class="test-option" onclick="answerPreTest(3, 'wrong', this)">5/2</button>
                                    <button class="test-option" onclick="answerPreTest(3, 'correct', this)">2/5</button>
                                    <button class="test-option" onclick="answerPreTest(3, 'wrong', this)">3/5</button>
                                    <button class="test-option" onclick="answerPreTest(3, 'wrong', this)">2/3</button>
                                </div>
                            </div>
                            
                            <div class="pre-test-result" id="preTestResult" style="display: none;">
                                <div class="recommendation" id="recommendation"></div>
                                <button class="btn-primary" id="startLearning" onclick="startAdaptedPath()">Commencer</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phase 2: Cours et Étapes d'apprentissage -->
        <div class="collapsible-section">
            <div class="collapsible-header" id="coursHeader" onclick="toggleSection('cours')">
                <span>📖 Phase 2: Cours et Étapes d'apprentissage</span>
                <span class="collapsible-icon">🔽</span>
            </div>
            <div class="collapsible-content" id="coursContent">
                <div class="collapsible-inner">
                    <div class="section" id="coursSection">
                        <h3>📖 Cours</h3>
                        <p>Une fraction représente une partie d'un tout. Exemple : 3/4 signifie 3 parts sur 4 au total.</p>
                    </div>

                    <div class="section">
                        <h3>🔢 Étapes d'apprentissage</h3>
                        <div class="etapes">
                            <ol>
                                <li>
                                    <strong>Identifier le numérateur et le dénominateur</strong>
                                    <div class="etape-detail">
                                        <strong>Comment :</strong> Dans une fraction a/b, le nombre du haut (a) est le numérateur (parts prises), le nombre du bas (b) est le dénominateur (total de parts). 
                                        <em>Exemple : dans 3/5, le numérateur est 3 et le dénominateur est 5.</em>
                                    </div>
                    </li>
                    <li>
                        <strong>Représenter une fraction sur un schéma</strong>
                        <div class="etape-detail">
                            <strong>Comment :</strong> Dessine une figure (cercle, rectangle, barre) et divise-la en autant de parts égales que le dénominateur, puis colorie le nombre de parts indiqué par le numérateur.
                            <em>Exemple : pour 2/3, divise en 3 parts et colorie 2 parts.</em>
                        </div>
                    </li>
                    <li>
                        <strong>Comparer et classer des fractions</strong>
                        <div class="etape-detail">
                            <strong>Comment :</strong> Si même dénominateur, compare les numérateurs. Sinon, convertis au même dénominateur ou utilise les décimaux.
                            <em>Exemple : 2/5 < 3/5 car 2 < 3. Pour 1/2 vs 2/3, convertis : 3/6 vs 4/6, donc 1/2 < 2/3.</em>
                        </div>
                    </li>
                </ol>
            </div>
        </div>

        <div class="section">
            <h3>💡 Exemple concret</h3>
            <p>Si tu manges 2 parts sur 8 d'un gâteau, tu as mangé 2/8, soit 1/4.</p>
        </div>
                </div>
            </div>
        </div>

        <!-- Phase 3: Exercices progressifs -->
        <div class="collapsible-section">
            <div class="collapsible-header" id="exercicesHeader" onclick="toggleSection('exercices')">
                <span>🏋️ Phase 3: Exercices progressifs</span>
                <span class="collapsible-icon">🔽</span>
            </div>
            <div class="collapsible-content" id="exercicesContent">
                <div class="collapsible-inner">
                    
                    <!-- Astuces & Pièges -->
                    <div class="section">
                        <h3>💡 Astuces & Pièges</h3>
                        <div class="astuce">
                            <strong>🎯 Astuce :</strong> Pour bien identifier une fraction, souviens-toi que le numérateur (en haut) indique combien de parts on prend, et le dénominateur (en bas) indique en combien de parts égales on divise le tout.
                        </div>
                        <div class="astuce" style="margin-top: 10px; background: linear-gradient(135deg, #fed7e2 0%, #fbb6ce 100%); border-left-color: #e53e3e;">
                            <strong>⚠️ Piège classique :</strong> Ne confonds pas 3/4 avec 4/3 ! Dans 3/4, on prend 3 parts sur 4. Dans 4/3, on prend 4 parts sur 3 (plus que le tout !).
                        </div>
                    </div>
                    
            <div class="section">                
                <div class="exercices">
                    <div class="exercice debutant">
                        <strong>🟢 Débutant</strong><br>
                        <p></p>Colorie 1/2 d'un rectangle.</p>
                        <div class="exercice-interactif">
                            <div class="rectangle-grid" id="rect-exercise">
                                <div class="rect-part" onclick="togglePart(this)"></div>
                                <div class="rect-part" onclick="togglePart(this)"></div>
                                <div class="rect-part" onclick="togglePart(this)"></div>
                                <div class="rect-part" onclick="togglePart(this)"></div>
                            </div>
                            <button onclick="checkRectangle()" class="check-btn">Vérifier</button>
                            <div id="rect-feedback" class="exercise-feedback"></div>
                        </div>
                    </div>
                    <div class="exercice intermediaire">
                        <strong>🟡 Intermédiaire</strong><br>
                        <p>Repère 3/4 sur une droite graduée.</p>
                        <div class="exercice-interactif">
                            <div class="number-line">
                                <div class="line"></div>
                                <div class="markers">
                                    <span class="marker" data-value="0">0</span>
                                    <span class="marker clickable" data-value="0.25" onclick="selectMarker(this, '1/4')">|</span>
                                    <span class="marker clickable" data-value="0.5" onclick="selectMarker(this, '1/2')">|</span>
                                    <span class="marker clickable" data-value="0.75" onclick="selectMarker(this, '3/4')">|</span>
                                    <span class="marker" data-value="1">1</span>
                                </div>
                            </div>
                            <p style="margin: 10px 0;">Clique sur la position de 3/4 :</p>
                            <div id="line-feedback" class="exercise-feedback"></div>
                        </div>
                    </div>
                    <div class="exercice avance">
                        <strong>🔴 Avancé</strong><br>
                        <p>Calcule : 5/8 d'un gâteau de 32 parts.</p>
                        <div class="exercice-interactif">
                            <div class="calculation-area">
                                <p>5/8 × 32 = ?</p>
                                <input type="number" id="calc-input" placeholder="Ta réponse" style="padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; width: 100px; margin: 10px;">
                                <button onclick="checkCalculation()" class="check-btn">Vérifier</button>
                                <div id="calc-feedback" class="exercise-feedback"></div>
                                <div class="hint" style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                    💡 Astuce : (5 × 32) ÷ 8
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Mini Quiz -->
                <div class="section">
                    <h3>🎯 Mini Quiz</h3>
                    <div class="quiz">
                        <p><strong>Question :</strong> Quelle fraction représente 2 parts sur 5 ?</p>
                        <div class="choix">
                            <span onclick="checkAnswer(this, false)">2/3</span>
                            <span onclick="checkAnswer(this, false)">5/2</span>
                            <span onclick="checkAnswer(this, true)">2/5</span>
                            <span onclick="checkAnswer(this, false)">1/2</span>
                        </div>
                        <div id="feedback" style="margin-top: 10px; font-weight: bold;"></div>
                    </div>
                </div>
                
                <!-- Défi -->
                <div class="section">
                    <h3>🚀 Défi</h3>
                    <div class="defi">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <span>Tu as 30 secondes pour trouver 3 fractions équivalentes à 2/3.</span>
                            <button onclick="startChallenge()" id="challengeBtn" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600;">Start ⏱️</button>
                        </div>
                        <div id="challengeTimer" style="display: none; text-align: center; font-size: 1.2rem; font-weight: bold; color: #9f7aea;"></div>
                        <div id="challengeInput" style="display: none; margin-top: 12px;">
                            <input type="text" placeholder="Ex: 4/6" style="padding: 8px; margin: 4px; border: 2px solid #e2e8f0; border-radius: 8px; width: 80px;">
                            <input type="text" placeholder="Ex: 6/9" style="padding: 8px; margin: 4px; border: 2px solid #e2e8f0; border-radius: 8px; width: 80px;">
                            <input type="text" placeholder="Ex: 8/12" style="padding: 8px; margin: 4px; border: 2px solid #e2e8f0; border-radius: 8px; width: 80px;">
                        </div>
                        <div id="challengeResult" style="margin-top: 12px; text-align: center; font-weight: bold;"></div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Phase 4: Réflexion et Métacognition -->
        <div class="collapsible-section">
            <div class="collapsible-header" id="metacognitionHeader" onclick="toggleSection('metacognition')">
                <span>🤔 Phase 4: Réflexion et Métacognition</span>
                <span class="collapsible-icon">🔽</span>
            </div>
            <div class="collapsible-content" id="metacognitionContent">
                <div class="collapsible-inner">
                    
                    <!-- Penses-tu avoir atteint l'objectif -->
                    <div class="section">
                        <h3>🎯 Penses-tu avoir atteint l'objectif</h3>
                        <div class="monitoring" id="monitoring-objectif">
                            <h4>📋 "Savoir lire, écrire et représenter une fraction"</h4>
                            <div class="monitoring-buttons">
                                <button class="monitoring-btn" onclick="rateSection('objectif', 4, this)">🎉 Complètement</button>
                                <button class="monitoring-btn" onclick="rateSection('objectif', 3, this)">👍 En grande partie</button>
                                <button class="monitoring-btn" onclick="rateSection('objectif', 2, this)">🤔 Partiellement</button>
                                <button class="monitoring-btn" onclick="rateSection('objectif', 1, this)">😔 Pas vraiment</button>
                            </div>
                            <div class="monitoring-feedback" id="feedback-objectif"></div>
                        </div>
                    </div>

                    <!-- Qu'est-ce qui t'a semblé le plus facile -->
                    <div class="section">
                        <div class="metacognition-question">
                            <h4>😊 Qu'est-ce qui t'a semblé le plus facile ?</h4>
                            <div class="metacognition-options">
                                <button class="meta-btn" onclick="selectMetaAnswer('facile', 'identifier', this)">🔍 Identifier le numérateur et le dénominateur</button>
                                <button class="meta-btn" onclick="selectMetaAnswer('facile', 'representer', this)">🎨 Représenter une fraction sur un schéma</button>
                                <button class="meta-btn" onclick="selectMetaAnswer('facile', 'exercices', this)">💪 Faire les exercices interactifs</button>
                                <button class="meta-btn" onclick="selectMetaAnswer('facile', 'comprendre', this)">💡 Comprendre le concept général</button>
                            </div>
                            <div class="meta-feedback" id="feedback-facile"></div>
                        </div>
                    </div>

                    <!-- Quelle a été la plus grande difficulté -->
                    <div class="section">
                        <div class="metacognition-question">
                            <h4>😅 Quelle a été la plus grande difficulté pour toi ?</h4>
                            <div class="metacognition-options">
                                <button class="meta-btn" onclick="selectMetaAnswer('difficile', 'confusion', this)">🔄 Confondre numérateur et dénominateur</button>
                                <button class="meta-btn" onclick="selectMetaAnswer('difficile', 'representation', this)">🎨 Représenter visuellement les fractions</button>
                                <button class="meta-btn" onclick="selectMetaAnswer('difficile', 'equivalence', this)">⚖️ Comprendre les fractions équivalentes</button>
                                <button class="meta-btn" onclick="selectMetaAnswer('difficile', 'aucune', this)">🌟 Aucune difficulté particulière</button>
                            </div>
                            <div class="meta-feedback" id="feedback-difficile"></div>
                        </div>
                    </div>

                    <!-- Comment utiliser dans la vie quotidienne -->
                    <div class="section">
                        <div class="metacognition-question">
                            <h4>🌟 Comment pourrais-tu utiliser les fractions dans ta vie de tous les jours ?</h4>
                            <div class="metacognition-options">
                                <button class="meta-btn" onclick="selectMetaAnswer('utilite', 'cuisine', this)">🍕 Partager une pizza ou découper un gâteau</button>
                                <button class="meta-btn" onclick="selectMetaAnswer('utilite', 'chocolat', this)">🍫 Partager une tablette de chocolat</button>
                                <button class="meta-btn" onclick="selectMetaAnswer('utilite', 'temps', this)">⏰ Comprendre les heures (1/2 heure, 1/4 d'heure)</button>
                                <button class="meta-btn" onclick="selectMetaAnswer('utilite', 'sport', this)">⚽ Compter les buts dans un match (2 buts sur 3 tentatives)</button>
                            </div>
                            <div class="meta-feedback" id="feedback-utilite"></div>
                        </div>
                    </div>
                    
                    <!-- Défi pratique personnalisé -->
                    <div class="practical-challenge" id="practicalChallenge" style="display: none;">
                        <h4>🎮 Défi pratique personnalisé</h4>
                        <div class="challenge-scenario" id="challengeScenario"></div>
                        <div class="challenge-input">
                            <input type="number" id="practicalAnswer" placeholder="Ta réponse">
                            <button onclick="checkPracticalChallenge()">Vérifier</button>
                        </div>
                        <div class="challenge-feedback" id="practicalFeedback"></div>
                    </div>
                    
                    <!-- Bouton pour finaliser -->
                    <div class="final-completion" id="finalCompletion" style="display: none;">
                        <button class="btn-primary celebration" onclick="completeMetacognition()">✨ J'ai terminé ma réflexion !</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales pour la pré-évaluation
        let preTestAnswers = {};
        let preTestScore = 0;
        let adaptedPath = 'beginner'; // 'beginner' ou 'advanced'
        let preTestCompleted = false; // Nouvelle variable pour tracker le pré-test
        
        // Variables pour la progression
        let progressCount = 0;
        let totalActivities = 5;
        
        // Variables pour les sections collapsibles et progression simplifiée
        let completedSections = new Set();
        let currentPhase = 1;
        let totalScore = 0;
        
        // Fonctions pour gérer les sections collapsibles
        function toggleSection(sectionName) {
            const content = document.getElementById(sectionName + 'Content');
            const header = document.getElementById(sectionName + 'Header');
            const icon = header.querySelector('.collapsible-icon');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                header.classList.remove('expanded');
                icon.textContent = '🔽';
            } else {
                content.classList.add('expanded');
                header.classList.add('expanded');
                icon.textContent = '🔼';
            }
        }
        
        function markSectionCompleted(sectionName) {
            completedSections.add(sectionName);
            const header = document.getElementById(sectionName + 'Header');
            if (header) {
                header.classList.add('completed');
            }
            updateProgressDisplay();
        }
        
        function updateProgressDisplay() {
            const phases = ['preEval', 'cours', 'exercices', 'metacognition'];
            const completedCount = completedSections.size;
            
            // La progression sera maintenant uniquement indiquée par les couleurs des titres
            console.log(`Progression: ${completedCount}/4 phases complétées`);
        }
        
        // Initialiser l'état par défaut (pré-évaluation ouverte)
        window.addEventListener('load', function() {
            toggleSection('preEval');
            updateProgressDisplay();
        });
        
        // Gestion de la pré-évaluation
        function answerPreTest(questionNumber, correctness, button) {
            // Désactiver tous les boutons de cette question
            const questionDiv = button.parentElement;
            const allButtons = questionDiv.querySelectorAll('.test-option');
            
            allButtons.forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.7';
                btn.style.cursor = 'not-allowed';
            });
            
            // Appliquer le style approprié
            if (correctness === 'correct') {
                button.classList.add('correct');
                preTestAnswers[questionNumber] = true;
            } else {
                button.classList.add('wrong');
                preTestAnswers[questionNumber] = false;
                // Montrer la bonne réponse
                allButtons.forEach(btn => {
                    if (btn.getAttribute('onclick').includes('correct')) {
                        btn.classList.add('correct');
                    }
                });
            }
            
            // Vérifier si toutes les questions sont répondues
            if (Object.keys(preTestAnswers).length === 3) {
                evaluatePreTest();
            }
        }
        
        function evaluatePreTest() {
            const correctAnswers = Object.values(preTestAnswers).filter(answer => answer).length;
            preTestScore = correctAnswers;
            
            const resultDiv = document.getElementById('preTestResult');
            const recommendationDiv = document.getElementById('recommendation');
            
            setTimeout(() => {
                if (correctAnswers >= 2) {
                    // Niveau avancé
                    adaptedPath = 'advanced';
                    recommendationDiv.innerHTML = `
                        <div class="recommendation advanced">
                            🌟 <strong>Super ! Tu as ${correctAnswers}/3 bonnes réponses.</strong><br>
                            Tu as déjà de bonnes bases. Passe aux exercices plus avancés pour te perfectionner.
                        </div>`;
                } else {
                    // Niveau débutant
                    adaptedPath = 'beginner';
                    recommendationDiv.innerHTML = `
                        <div class="recommendation beginner">
                            💪 <strong>Tu as ${correctAnswers}/3 bonnes réponses.</strong><br>
                            Pas de panique ! C'est le bon moment pour revoir le cours. On reprend ensemble les bases.
                        </div>`;
                }
                
                resultDiv.style.display = 'block';
                resultDiv.scrollIntoView({ behavior: 'smooth' });
                
                // Marquer le pré-test comme terminé et mettre à jour la progression
                preTestCompleted = true;
                markSectionCompleted('preEval'); // Marquer la section comme terminée
            }, 1000);
        }
        
        function startAdaptedPath() {
            // Fermer la pré-évaluation et ouvrir la section appropriée
            markSectionCompleted('preEval');
            toggleSection('preEval');
            
            if (adaptedPath === 'advanced') {
                // Pour le niveau avancé, ouvrir directement les exercices
                toggleSection('exercices');
                setTimeout(() => {
                    document.getElementById('exercicesContent').scrollIntoView({ behavior: 'smooth' });
                }, 400);
            } else {
                // Pour les débutants, ouvrir d'abord le cours
                toggleSection('cours');
                setTimeout(() => {
                    document.getElementById('coursContent').scrollIntoView({ behavior: 'smooth' });
                }, 400);
            }
        }
        
        // Fonction pour mettre à jour la barre de progression
        function updateProgress(activity) {
            const segment = document.querySelector(`[data-exercise="${activity}"]`);
            
            if (segment && !segment.classList.contains('filled')) {
                segment.classList.add('filled');
                progressCount++;
                
                // Messages personnalisés selon l'activité
                const activityNames = {
                    'pretest': 'Pré-évaluation',
                    'rect': 'Rectangle colorié',
                    'number': 'Droite numérique',
                    'calc': 'Calcul',
                    'objectif': 'Objectif évalué'
                };
                
                // Mettre à jour le texte avec le nom de l'activité terminée
                const progressText = document.getElementById('progressText');
                const activityName = activityNames[activity] || 'Activité';
                progressText.innerHTML = `✅ <strong>${activityName}</strong> • ${progressCount}/${totalActivities} terminées`;
                
                // Animation de celebration si tout est fini
                if (progressCount === totalActivities) {
                    setTimeout(() => {
                        progressText.innerHTML = '🎉 <strong>Bravo ! Tu as terminé toutes les activités avec succès !</strong>';
                        progressText.style.color = '#38a169';
                        progressText.style.fontWeight = 'bold';
                        
                        // Petit effet confetti textuel
                        setTimeout(() => {
                            progressText.innerHTML += '<br><small>🎊 Tu peux être fier de ton travail ! 🌟</small>';
                        }, 1000);
                    }, 500);
                }
            }
        }
        
        function checkAnswer(element, isCorrect) {
            const feedback = document.getElementById('feedback');
            const choices = document.querySelectorAll('.choix span');
            
            // Reset all choices
            choices.forEach(choice => {
                choice.style.background = 'linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%)';
                choice.style.color = '#2d3748';
                choice.style.border = '2px solid transparent';
            });
            
            if (isCorrect) {
                element.style.background = 'linear-gradient(135deg, #68d391 0%, #38b2ac 100%)';
                element.style.color = 'white';
                element.style.border = '2px solid #22543d';
                feedback.innerHTML = '🎉 <strong>Correct ! Excellent travail.</strong><br>Tu as bien compris que 2 parts sur 5 s\'écrit 2/5. Tu maîtrises la lecture des fractions !';
                feedback.className = 'feedback-success';
                
                // Ajouter les points quiz (bonus de 20 points)
                if (!monitoringScores.quiz) {
                    monitoringScores.quiz = 20;
                    maxScores.quiz = 20;
                    updateTotalScore();
                    // Le quiz est un bonus, pas dans la progression principale
                }
            } else {
                element.style.background = 'linear-gradient(135deg, #fc8181 0%, #f56565 100%)';
                element.style.color = 'white';
                element.style.border = '2px solid #742a2a';
                feedback.innerHTML = '❌ <strong>Pas tout à fait !</strong><br>Souviens-toi : quand on voit 2 parts coloriées sur 5 parts au total, cela s\'écrit 2/5. Le numérateur (en haut) indique le nombre de parts prises.';
                feedback.className = 'feedback-error';
            }
        }

        let challengeTimer;
        let timeLeft;
        let selectedParts = 0;
        let selectedMarker = null;

        // Exercice 1: Rectangle à colorier
        function togglePart(element) {
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                selectedParts--;
            } else {
                element.classList.add('selected');
                selectedParts++;
            }
        }

        function checkRectangle() {
            const feedback = document.getElementById('rect-feedback');
            const totalParts = 4;
            const targetParts = totalParts / 2; // 1/2 = 2 parts sur 4
            
            if (selectedParts === targetParts) {
                feedback.innerHTML = '🎉 <strong>Bravo ! C\'est exactement ça.</strong><br>Tu as bien compris comment représenter une fraction : 1/2 = 2 parts coloriées sur 4 parts au total.';
                feedback.className = 'exercise-feedback feedback-success';
                exercisesCompleted.rectangle = true;
                updateExerciseProgress();
                updateProgress('rect'); // Mettre à jour la barre de progression
            } else if (selectedParts === 0) {
                feedback.innerHTML = '💡 <strong>Allez, tu peux le faire !</strong><br>Pour représenter 1/2, colorie 2 cases sur les 4 disponibles.';
                feedback.className = 'exercise-feedback feedback-error';
            } else if (selectedParts > targetParts) {
                feedback.innerHTML = `❌ <strong>Presque !</strong><br>Tu as colorié ${selectedParts} parts, mais pour 1/2 il en faut seulement 2. Souviens-toi : 1/2 signifie "1 part sur 2", donc la moitié du rectangle.`;
                feedback.className = 'exercise-feedback feedback-error';
            } else {
                feedback.innerHTML = `❌ <strong>Pas encore !</strong><br>Tu as colorié ${selectedParts} part${selectedParts > 1 ? 's' : ''}, mais pour 1/2 il en faut 2. Continue, tu es sur la bonne voie !`;
                feedback.className = 'exercise-feedback feedback-error';
            }
        }

        // Exercice 2: Droite graduée
        function selectMarker(element, fraction) {
            // Reset previous selection
            if (selectedMarker) {
                selectedMarker.classList.remove('selected');
            }
            
            // Select new marker
            element.classList.add('selected');
            selectedMarker = element;
            
            const feedback = document.getElementById('line-feedback');
            
            if (fraction === '3/4') {
                feedback.innerHTML = '🎯 <strong>Excellent ! Tu as visé juste.</strong><br>3/4 (trois quarts) est effectivement à cette position. Tu maîtrises bien le placement des fractions sur la droite !';
                feedback.className = 'exercise-feedback feedback-success';
                exercisesCompleted.droite = true;
                updateExerciseProgress();
                updateProgress('number'); // Mettre à jour la barre de progression
            } else if (fraction === '1/2') {
                feedback.innerHTML = `❌ <strong>Pas tout à fait !</strong><br>Tu as sélectionné 1/2 (la moitié), mais on cherche 3/4. Souviens-toi : 3/4 signifie "3 parts sur 4", donc c'est plus proche de la fin que du milieu.`;
                feedback.className = 'exercise-feedback feedback-error';
            } else if (fraction === '1/4') {
                feedback.innerHTML = `❌ <strong>Ce n'est pas ça !</strong><br>Tu as choisi 1/4 (un quart), mais on cherche 3/4 (trois quarts). 3/4 est beaucoup plus grand que 1/4 !`;
                feedback.className = 'exercise-feedback feedback-error';
            } else {
                feedback.innerHTML = `❌ <strong>Essaie encore !</strong><br>Tu as sélectionné ${fraction}. Cherche 3/4 (trois quarts) - c'est entre 1/2 et 1.`;
                feedback.className = 'exercise-feedback feedback-error';
            }
        }

        // Exercice 3: Calcul
        function checkCalculation() {
            const input = document.getElementById('calc-input');
            const feedback = document.getElementById('calc-feedback');
            const answer = parseInt(input.value);
            const correct = 20; // 5/8 × 32 = (5 × 32) ÷ 8 = 160 ÷ 8 = 20
            
            if (answer === correct) {
                feedback.innerHTML = '🍰 <strong>Bravo ! C\'est exactement ça.</strong><br>Tu as bien compris comment calculer une fraction d\'un nombre : 5/8 × 32 = 20 parts de gâteau. Tu maîtrises les calculs avec les fractions !';
                feedback.className = 'exercise-feedback feedback-success';
                exercisesCompleted.calcul = true;
                updateExerciseProgress();
                updateProgress('calc'); // Mettre à jour la barre de progression
            } else if (isNaN(answer)) {
                feedback.innerHTML = '💡 <strong>N\'oublie pas de répondre !</strong><br>Entre un nombre pour calculer combien font 5/8 de 32 parts de gâteau.';
                feedback.className = 'exercise-feedback feedback-error';
            } else if (answer === 160) {
                feedback.innerHTML = `❌ <strong>Presque !</strong><br>Tu as calculé 5 × 32 = 160, mais n'oublie pas de diviser par 8 ! Donc : 160 ÷ 8 = ?`;
                feedback.className = 'exercise-feedback feedback-error';
            } else if (answer === 4) {
                feedback.innerHTML = `❌ <strong>Attention au calcul !</strong><br>Tu as peut-être calculé 32 ÷ 8 = 4, mais il faut multiplier par 5 aussi. Méthode : (5 × 32) ÷ 8.`;
                feedback.className = 'exercise-feedback feedback-error';
            } else {
                feedback.innerHTML = `❌ <strong>${answer} n'est pas correct.</strong><br>Souviens-toi de la méthode : pour calculer 5/8 de 32, fais (5 × 32) ÷ 8. Essaie encore !`;
                feedback.className = 'exercise-feedback feedback-error';
            }
        }

        function startChallenge() {
            const btn = document.getElementById('challengeBtn');
            const timer = document.getElementById('challengeTimer');
            const input = document.getElementById('challengeInput');
            const result = document.getElementById('challengeResult');
            
            // Reset
            result.innerHTML = '';
            timeLeft = 30;
            
            // Show timer and inputs
            timer.style.display = 'block';
            input.style.display = 'block';
            btn.style.display = 'none';
            
            // Clear inputs
            input.querySelectorAll('input').forEach(inp => {
                inp.value = '';
                inp.style.backgroundColor = 'white';
            });
            
            // Start countdown
            challengeTimer = setInterval(() => {
                timer.innerHTML = `⏱️ ${timeLeft}s`;
                timeLeft--;
                
                if (timeLeft < 10) {
                    timer.style.color = '#f56565';
                }
                
                if (timeLeft < 0) {
                    endChallenge();
                }
            }, 1000);
        }

        function endChallenge() {
            clearInterval(challengeTimer);
            const timer = document.getElementById('challengeTimer');
            const input = document.getElementById('challengeInput');
            const result = document.getElementById('challengeResult');
            const btn = document.getElementById('challengeBtn');
            
            timer.innerHTML = '⏰ Temps écoulé !';
            
            // Check answers
            const inputs = input.querySelectorAll('input');
            const answers = Array.from(inputs).map(inp => inp.value.trim());
            const validAnswers = ['4/6', '6/9', '8/12', '10/15', '12/18', '14/21'];
            
            let correct = 0;
            answers.forEach((answer, index) => {
                if (validAnswers.includes(answer)) {
                    inputs[index].style.backgroundColor = '#c6f6d5';
                    correct++;
                } else if (answer) {
                    inputs[index].style.backgroundColor = '#fed7d7';
                }
            });
            
            if (correct === 3) {
                result.innerHTML = '🎉 Parfait ! Tu as trouvé 3 fractions équivalentes !';
                result.style.color = '#22543d';
            } else if (correct > 0) {
                result.innerHTML = `👍 Bien ! Tu en as trouvé ${correct}/3. Exemples : 4/6, 6/9, 8/12`;
                result.style.color = '#744210';
            } else {
                result.innerHTML = '💪 Pas grave ! Exemples : 4/6, 6/9, 8/12 (multiplie haut et bas par 2, 3, 4...)';
                result.style.color = '#9f7aea';
            }
            
            // Reset button
            setTimeout(() => {
                btn.style.display = 'inline-block';
                btn.innerHTML = 'Rejouer ⏱️';
                timer.style.display = 'none';
            }, 3000);
        }

        // Système de monitoring et scoring
        let monitoringScores = {
            objectif: 0
        };
        
        let maxScores = {
            objectif: 60     // 60 points max pour atteinte de l'objectif (était 30 exemple + 30 objectif)
            // + 40 points max pour les 3 exercices interactifs (auto-calculés)
        };
        
        // Suivi des exercices interactifs (40 points total)
        let exercisesCompleted = {
            rectangle: false,    // 15 points
            droite: false,       // 15 points  
            calcul: false        // 10 points
        };
        
        let exercisePoints = {
            rectangle: 15,
            droite: 15,
            calcul: 10
        };

        function rateSection(section, rating, button) {
            // Reset visual state of all buttons in this section
            const sectionButtons = button.parentElement.querySelectorAll('.monitoring-btn');
            sectionButtons.forEach(btn => {
                btn.className = 'monitoring-btn';
            });
            
            // Apply appropriate style to selected button
            const styles = ['difficile', 'moyen', 'bon', 'excellent'];
            button.className = `monitoring-btn ${styles[rating - 1]}`;
            
            // Calculer le score (rating de 1-4, convertir en pourcentage des points max)
            const scorePercent = (rating / 4);
            monitoringScores[section] = Math.round(maxScores[section] * scorePercent);
            
            // Ajouter au score total
            totalScore = Object.values(monitoringScores).reduce((sum, score) => sum + score, 0) +
                        Object.entries(exercisesCompleted)
                            .filter(([key, completed]) => completed)
                            .reduce((sum, [key]) => sum + exercisePoints[key], 0);
            
            // Afficher le feedback
            const feedback = document.getElementById(`feedback-${section}`);
            const feedbacks = {
                1: { text: '💪 Pas de souci, on progresse étape par étape !', class: 'feedback-error' },
                2: { text: '🤔 C\'est normal, les fractions demandent de la pratique.', class: 'feedback-error' },
                3: { text: '👍 Bon travail ! Tu es sur la bonne voie.', class: 'feedback-success' },
                4: { text: '🎉 Excellent ! Tu maîtrises bien cette partie.', class: 'feedback-success' }
            };
            
            feedback.innerHTML = feedbacks[rating].text;
            feedback.className = `monitoring-feedback ${feedbacks[rating].class}`;
            
            updateProgressDisplay();
        }

        function updateTotalScore() {
            // Score des sections de monitoring (objectif seulement maintenant)
            const monitoringTotal = Object.values(monitoringScores).reduce((sum, score) => sum + score, 0);
            
            // Score des exercices interactifs
            const exerciseTotal = Object.entries(exercisesCompleted)
                .filter(([key, completed]) => completed)
                .reduce((sum, [key]) => sum + exercisePoints[key], 0);
            
            // Score du quiz (s'il existe)
            const quizScore = monitoringScores.quiz || 0;
            
            const totalScore = monitoringTotal + exerciseTotal + quizScore;
            
            // Calcul de progression basé sur les activités terminées (5 total avec pré-test)
            const completedExercises = Object.values(exercisesCompleted).filter(Boolean).length;
            const hasObjectiveRating = monitoringScores.objectif > 0;
            const hasQuizScore = (monitoringScores.quiz || 0) > 0;
            
            // Compter les activités terminées (5 total: 1 pré-test + 3 exercices + 1 objectif)
            let completedActivities = completedExercises;
            if (hasObjectiveRating) completedActivities++;
            if (preTestCompleted) completedActivities++; // Utiliser la variable dédiée
            
            const totalActivitiesDisplay = 5; // 1 pré-test + 3 exercices + 1 objectif
            
            document.getElementById('totalScore').textContent = totalScore;
            
            const progressPercent = Math.round((completedActivities / totalActivitiesDisplay) * 100);
            
            document.getElementById('scoreBreakdown').innerHTML = 
                `Activités: ${completedActivities}/${totalActivitiesDisplay} • Score: ${totalScore}/120 pts${hasQuizScore ? ' + bonus quiz' : ''}`;
            
            // Feedback général basé sur le score total (sur 120 pts: 60 objectif + 40 exercices + 20 bonus)
            if (totalScore >= 100) {
                document.getElementById('scoreBreakdown').innerHTML += ' 🌟 Excellent !';
            } else if (totalScore >= 85) {
                document.getElementById('scoreBreakdown').innerHTML += ' 👍 Très bon niveau !';
            } else if (totalScore >= 70) {
                document.getElementById('scoreBreakdown').innerHTML += ' � Bon niveau !';
            } else if (totalScore >= 50) {
                document.getElementById('scoreBreakdown').innerHTML += ' � À améliorer';
            }
        }

        function updateExerciseProgress() {
            // Calculer le score total des exercices
            const exerciseTotal = Object.entries(exercisesCompleted)
                .filter(([key, completed]) => completed)
                .reduce((sum, [key]) => sum + exercisePoints[key], 0);
            
            const quizScore = monitoringScores.quiz || 0;
            totalScore = exerciseTotal + quizScore;
            
            // Vérifier si tous les exercices sont terminés
            const completedExercises = Object.values(exercisesCompleted).filter(Boolean).length;
            const totalExercises = Object.keys(exercisesCompleted).length;
            
            if (completedExercises === totalExercises && !completedSections.has('exercices')) {
                markSectionCompleted('exercices');
                // Ouvrir automatiquement la métacognition
                setTimeout(() => {
                    toggleSection('metacognition');
                    document.getElementById('metacognitionContent').scrollIntoView({ behavior: 'smooth' });
                }, 1000);
            }
            
            updateProgressDisplay();
        }

        function updateCompetenceBadgesDetailed() {
            // Nouvelles métriques de progression
            const hasObjectiveRating = monitoringScores.objectif > 0;
            const completedExercises = Object.values(exercisesCompleted).filter(Boolean).length;
            const totalExercises = Object.keys(exercisesCompleted).length;
            const hasQuizScore = (monitoringScores.quiz || 0) > 0;
            
            // Score total pour les niveaux
            const totalScore = Object.values(monitoringScores).reduce((sum, score) => sum + score, 0) +
                             Object.entries(exercisesCompleted)
                                .filter(([key, completed]) => completed)
                                .reduce((sum, [key]) => sum + exercisePoints[key], 0);
            
            const completionBadge = document.getElementById('completionBadge');
            const levelBadge = document.getElementById('levelBadge');
            
            // Badge de complétion basé sur les activités
            let completedActivities = completedExercises;
            if (hasObjectiveRating) completedActivities++;
            if (preTestCompleted) completedActivities++; // Utiliser la variable dédiée
            const totalActivitiesComplete = 5; // 1 pré-test + 3 exercices + 1 objectif
            
            if (completedActivities === totalActivitiesComplete) {
                completionBadge.textContent = '🎉 Toutes les activités terminées !';
                completionBadge.className = 'completion-badge termine';
            } else {
                const pretestText = preTestCompleted ? '✅ pré-test' : '⏳ pré-test';
                const exercisesText = `${completedExercises}/${totalExercises} exercices`;
                const objectiveText = hasObjectiveRating ? '✅ objectif évalué' : '⏳ objectif à évaluer';
                completionBadge.textContent = `⏳ ${pretestText} • ${exercisesText} • ${objectiveText}`;
                completionBadge.className = 'completion-badge en-cours';
            }
            
            // Badge de niveau (si au moins des exercices terminés ou objectif évalué)
            if (completedExercises > 0 || hasObjectiveRating) {
                // Adaptation des seuils pour le nouveau système (max 120 pts)
                if (totalScore >= 100) {
                    levelBadge.textContent = '🌟 Excellent';
                    levelBadge.className = 'level-badge excellent';
                } else if (totalScore >= 85) {
                    levelBadge.textContent = '👍 Très bon niveau';
                    levelBadge.className = 'level-badge bon';
                } else if (totalScore >= 70) {
                    levelBadge.textContent = '📚 Bon niveau';
                    levelBadge.className = 'level-badge moyen';
                } else if (totalScore >= 50) {
                    levelBadge.textContent = '💪 À améliorer';
                    levelBadge.className = 'level-badge debutant';
                } else {
                    levelBadge.textContent = '🎯 Début d\'apprentissage';
                    levelBadge.className = 'level-badge debutant';
                }
            } else {
                levelBadge.textContent = '🚀 Prêt à commencer';
                levelBadge.className = 'level-badge non-evalue';
            }
        }

        // Variables pour la métacognition
        let metacognitionAnswers = {};
        let metacognitionComplete = false;

        // Fonction pour gérer les réponses de métacognition
        function selectMetaAnswer(category, answer, button) {
            // Désélectionner les autres boutons de cette catégorie
            const categoryButtons = button.parentElement.querySelectorAll('.meta-btn');
            categoryButtons.forEach(btn => btn.classList.remove('selected'));
            
            // Sélectionner ce bouton
            button.classList.add('selected');
            metacognitionAnswers[category] = answer;
            
            // Afficher le feedback approprié
            showMetaFeedback(category, answer);
            
            // Vérifier si on peut afficher le défi pratique
            checkMetacognitionProgress();
        }

        function showMetaFeedback(category, answer) {
            const feedback = document.getElementById(`feedback-${category}`);
            let message = '';
            
            switch(category) {
                case 'facile':
                    const facileMessages = {
                        'exemples': 'Super ! Comprendre les exemples est la base de tout apprentissage. 📚',
                        'colorage': 'Excellent ! La représentation visuelle t\'aide à bien saisir les concepts. 🎨',
                        'droite': 'Parfait ! Tu as une bonne perception spatiale des nombres. 📏',
                        'calcul': 'Bravo ! Tu es à l\'aise avec les calculs, c\'est un atout. 🔢'
                    };
                    message = facileMessages[answer];
                    break;
                    
                case 'difficile':
                    const difficileMessages = {
                        'vocabulaire': 'C\'est normal, le vocabulaire mathématique demande de la pratique. Continue à réviser ! 📝',
                        'representation': 'Les représentations visuelles s\'améliorent avec l\'entraînement. Persévère ! 🎨',
                        'placement': 'Le placement précis viendra avec la pratique. Tu progresses ! 📍',
                        'calculs': 'Les calculs avec fractions demandent du temps. Garde confiance ! 🧮'
                    };
                    message = difficileMessages[answer];
                    break;
                    
                case 'utilite':
                    const utiliteMessages = {
                        'cuisine': 'Exactement ! La cuisine est pleine de fractions : 1/2 cuillère, 3/4 de verre... 🍕',
                        'chocolat': 'Très bon exemple ! Partager équitablement, c\'est de la mathématique ! 🍫',
                        'temps': 'Parfait ! Le temps utilise beaucoup les fractions dans la vie quotidienne. ⏰',
                        'sport': 'Super ! Les statistiques sportives utilisent beaucoup les fractions. ⚽'
                    };
                    message = utiliteMessages[answer];
                    break;
            }
            
            feedback.innerHTML = message;
            feedback.classList.add('show');
        }

        function checkMetacognitionProgress() {
            // Vérifier si toutes les questions sont répondues
            if (Object.keys(metacognitionAnswers).length === 3) {
                // Afficher le défi pratique personnalisé
                setTimeout(() => {
                    showPracticalChallenge();
                }, 1000);
            }
        }

        function showPracticalChallenge() {
            const challengeDiv = document.getElementById('practicalChallenge');
            const scenarioDiv = document.getElementById('challengeScenario');
            
            // Créer un défi basé sur l'utilité choisie
            const utilityChoice = metacognitionAnswers.utilite;
            let scenario = '';
            let correctAnswer = 0;
            
            switch(utilityChoice) {
                case 'cuisine':
                    scenario = '🍕 <strong>Défi Pizza !</strong><br>Tom commande une pizza de 12 parts. Il en mange 1/4 et sa sœur en mange 1/3. Combien de parts reste-t-il ?<br><small>(Aide: 1/4 de 12 = 3 parts, 1/3 de 12 = 4 parts)</small>';
                    correctAnswer = 5; // 12 - 3 - 4 = 5
                    break;
                case 'chocolat':
                    scenario = '🍫 <strong>Défi Chocolat !</strong><br>Marie a une tablette de 24 carreaux. Son petit frère a mangé 1/4 de la tablette. Combien de carreaux a-t-il mangés ?<br><small>(Aide: 1/4 de 24 = ?)</small>';
                    correctAnswer = 6; // 24 ÷ 4 = 6
                    break;
                case 'temps':
                    scenario = '⏰ <strong>Défi Temps !</strong><br>Lisa fait ses devoirs pendant 3/4 d\'heure. Combien cela fait-il en minutes ?<br><small>(Aide: 1 heure = 60 minutes)</small>';
                    correctAnswer = 45; // 3/4 × 60 = 45
                    break;
                case 'sport':
                    scenario = '⚽ <strong>Défi Sport !</strong><br>Dans un match, Paul tire 15 fois au but et marque 2/5 de ses tirs. Combien de buts a-t-il marqués ?<br><small>(Aide: 2/5 de 15 = ?)</small>';
                    correctAnswer = 6; // 2/5 × 15 = 6
                    break;
            }
            
            scenarioDiv.innerHTML = scenario;
            window.practicalCorrectAnswer = correctAnswer;
            challengeDiv.style.display = 'block';
            challengeDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function checkPracticalChallenge() {
            const input = document.getElementById('practicalAnswer');
            const feedback = document.getElementById('practicalFeedback');
            const answer = parseInt(input.value);
            
            if (answer === window.practicalCorrectAnswer) {
                feedback.innerHTML = '🎉 <strong>Fantastique !</strong> Tu sais maintenant utiliser les fractions dans la vraie vie !';
                feedback.className = 'challenge-feedback feedback-success';
                feedback.style.display = 'block';
                
                // Afficher le bouton de finalisation
                setTimeout(() => {
                    document.getElementById('finalCompletion').style.display = 'block';
                    updateProgress('final'); // Dernière progression
                }, 1000);
            } else if (isNaN(answer)) {
                feedback.innerHTML = '💡 N\'oublie pas de donner ta réponse !';
                feedback.className = 'challenge-feedback feedback-error';
                feedback.style.display = 'block';
            } else {
                feedback.innerHTML = `❌ Pas tout à fait ! Relis bien l'énoncé et réessaie. La bonne réponse n'est pas ${answer}.`;
                feedback.className = 'challenge-feedback feedback-error';
                feedback.style.display = 'block';
            }
        }

        function completeMetacognition() {
            metacognitionComplete = true;
            markSectionCompleted('metacognition');
            
            // Animation de célébration
            const btn = document.querySelector('.btn-primary.celebration');
            btn.innerHTML = '🎊 Bravo ! Tu as terminé ! 🎊';
            btn.style.background = 'linear-gradient(135deg, #48bb78 0%, #38a169 100%)';
            
            // Mettre à jour l'affichage de progression
            updateProgressDisplay();
            
            // Petit feu d'artifice textuel
            setTimeout(() => {
                alert('🎉 Félicitations ! Tu as terminé cette leçon sur les fractions avec succès ! Tu peux être fier de ton travail. 🌟');
            }, 500);
        }

        // Améliorer la fonction rateSection pour afficher la métacognition à la fin
        const originalRateSection = rateSection;
        rateSection = function(section, rating, button) {
            originalRateSection(section, rating, button);
            
            // Si c'est la section objectif et que c'est la première fois qu'on la rate
            if (section === 'objectif' && !metacognitionComplete) {
                setTimeout(() => {
                    document.getElementById('metacognitionSection').style.display = 'block';
                    document.getElementById('metacognitionSection').scrollIntoView({ behavior: 'smooth' });
                }, 1500);
            }
        };
    </script>
</body>
</html>
